name: Build

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    if: github.repository == 'jdperos/chrono-cross-decomp'

    strategy:
      matrix:
        # Can add more versions to support multiple (NTSC-J, PAL, etc.)
        game_id: [ slps_023.64 ]
      fail-fast: false

    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -U -r requirements.txt

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            make \
            binutils-mips-linux-gnu \
            cpp-mips-linux-gnu \
            7zip

      - name: Download ROM from private repository
        uses: actions/checkout@v4
        with:
          repository: jdperos/chrono-cross-decomp-dependencies
          token: ${{ secrets.DECOMP_DEPENDENCIES_TOKEN }}
          path: tmp

      - name: Reassemble ROM
        run: |
          mkdir -p disc
          cat tmp/x* > disc/cdrom.dat
          rm -rf tmp
          echo "ROM size: $(stat -c%s disc/cdrom.dat) bytes"

      - name: Extract and prepare
        run: |
          make extract

      - name: Generate ASM splits
        run: make generate

      - name: Build source objects
        run: make build

      # Don't run a check while we're generating fuzzy progress from nonmatching branch
      # - name: Check for match
      #   run: make check
      #   continue-on-error: true  # Don't fail workflow if not matching

      - name: Generate progress report
        # Only generate on master branch pushes
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: make report

      - name: Upload progress report
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.game_id }}_report
          path: build/progress.json

      - name: Upload build artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.game_id }}
          path: |
            build/
            !build/**/*.o